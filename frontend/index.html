<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FastAPI Todo App</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    .box { max-width: 450px; margin: auto; padding: 20px; background: white; border-radius: 8px; }
    input, button { width: 100%; padding: 10px; margin-top: 8px; }
    .todo { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; }
    .completed { text-decoration: line-through; color: gray; }
  </style>
</head>
<body>

<div class="box">
  <h2>FastAPI Todo App</h2>

  <h3>Register</h3>
  <input id="reg-user" placeholder="Username">
  <input id="reg-pass" placeholder="Password" type="password">
  <button onclick="register()">Register</button>

  <h3>Login</h3>
  <input id="log-user" placeholder="Username">
  <input id="log-pass" placeholder="Password" type="password">
  <button onclick="login()">Login</button>

  <p id="status"></p>

  <h3>Your Todos</h3>
  <input id="todo-title" placeholder="New todo...">
  <button onclick="addTodo()">Add Todo</button>

  <div id="list"></div>
</div>

<script>
  const API = "http://127.0.0.1:8000";
  let token = localStorage.getItem("token");

  function msg(t) { document.getElementById("status").innerText = t; }

  async function register() {
    let username = document.getElementById("reg-user").value;
    let password = document.getElementById("reg-pass").value;

    let res = await fetch(API + "/users/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    msg(res.ok ? "Registration successful" : "Error registering");
  }

  async function login() {
    let fd = new URLSearchParams();
    fd.append("username", document.getElementById("log-user").value);
    fd.append("password", document.getElementById("log-pass").value);

    let res = await fetch(API + "/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: fd
    });

    let data = await res.json();
    if (data.access_token) {
      token = data.access_token;
      localStorage.setItem("token", token);
      msg("Login successful");
      loadTodos();
    } else msg("Invalid login");
  }

  async function loadTodos() {
    let res = await fetch(API + "/todos/", {
      headers: { "Authorization": "Bearer " + token }
    });

    let todos = await res.json();
    let list = document.getElementById("list");
    list.innerHTML = "";

    todos.forEach(t => {
      let div = document.createElement("div");
      div.className = "todo" + (t.completed ? " completed" : "");
      div.innerHTML = `
        <span>${t.title}</span>
        <button onclick="del(${t.id})">Delete</button>
      `;
      list.appendChild(div);
    });
  }

  async function addTodo() {
    let title = document.getElementById("todo-title").value;
    if (!title) return;

    await fetch(API + "/todos/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ title })
    });

    document.getElementById("todo-title").value = "";
    loadTodos();
  }

  async function del(id) {
    await fetch(API + "/todos/" + id, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });

    loadTodos();
  }

  if (token) loadTodos();
</script>

</body>
</html>
